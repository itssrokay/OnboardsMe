import{a as v}from"./chunk-57NZOXBA.js";import{a as g,b as l,fa as h,k as S,n as I,w as P}from"./chunk-PYF3QQPI.js";var f=class d{courseService=I(v);PROGRESS_KEY="onboardsMe_progress";progressStore=P(this.loadProgressStore());getCourseProgress(e){return this.progressStore().courses[e]||null}getAllProgress=h(()=>this.progressStore().courses);isItemCompleted(e){return this.progressStore().items[e]?.completedAt!==void 0}getCourseCompletionPercentage(e){let t=this.getCourseProgress(e);return t?t.progressPercentage:0}getLessonCompletionPercentage(e,t){let o=this.courseService.getCourseById(e)?.lessons.find(i=>i.id===t);if(!o)return 0;let r=o.learningItems.filter(i=>this.isItemCompleted(i.id)).length;return Math.round(r/o.learningItems.length*100)}getCompletedItemsCount(e){return this.getCourseProgress(e)?.completedCount||0}markItemCompleted(e,t,s){let o=this.progressStore(),r=new Date().toISOString(),i={itemId:s,lessonId:t,courseId:e,completedAt:r,urlVisited:!0,pdfOpened:!0,videoProgress:{currentTime:0,duration:0,completed:!0}},m=l(g({},o.items),{[s]:i}),n=o.courses[e],c=this.courseService.getCourseById(e),a=this.courseService.getTotalItemsInCourse(e);if(!n)n={courseId:e,enrolledAt:r,lastViewedAt:r,lastLessonId:t,lastItemId:s,completedItems:[s],totalItems:a,completedCount:1,progressPercentage:Math.round(1/a*100)};else{let p=n.completedItems.includes(s)?n.completedItems:[...n.completedItems,s];n=l(g({},n),{lastViewedAt:r,lastLessonId:t,lastItemId:s,completedItems:p,completedCount:p.length,progressPercentage:Math.round(p.length/a*100)})}let u={courses:l(g({},o.courses),{[e]:n}),items:m,lastActivity:r};this.progressStore.set(u),this.saveProgressStore(u)}markItemStarted(e,t,s){let o=this.progressStore(),r=new Date().toISOString();if(!o.items[s]?.completedAt){let m={itemId:s,lessonId:t,courseId:e,urlVisited:!0,pdfOpened:!0},n=l(g({},o.items),{[s]:m}),c=o.courses[e],a=this.courseService.getTotalItemsInCourse(e);c?c=l(g({},c),{lastViewedAt:r,lastLessonId:t,lastItemId:s}):c={courseId:e,enrolledAt:r,lastViewedAt:r,lastLessonId:t,lastItemId:s,completedItems:[],totalItems:a,completedCount:0,progressPercentage:0};let u={courses:l(g({},o.courses),{[e]:c}),items:n,lastActivity:r};this.progressStore.set(u),this.saveProgressStore(u)}}updateVideoProgress(e,t,s,o,r){let i=this.progressStore(),m=new Date().toISOString(),n=i.items[s]||{itemId:s,lessonId:t,courseId:e},c=r>0&&o/r>=.9,a=l(g({},n),{videoProgress:{currentTime:o,duration:r,completed:c}});if(c&&!n.completedAt){a.completedAt=m,this.markItemCompleted(e,t,s);return}let u=l(g({},i),{items:l(g({},i.items),{[s]:a}),lastActivity:m});this.progressStore.set(u),this.saveProgressStore(u)}getLastViewedItem(e){let t=this.getCourseProgress(e);return!t||!t.lastLessonId||!t.lastItemId?null:{lessonId:t.lastLessonId,itemId:t.lastItemId}}getResumePoint(e){let t=this.courseService.getCourseById(e);if(!t)return null;let s=this.getLastViewedItem(e);if(s){if(!this.isItemCompleted(s.itemId))return s;let r=this.courseService.getNextLearningItem(e,s.lessonId,s.itemId);if(r)return{lessonId:r.lesson.id,itemId:r.item.id}}for(let r of t.lessons)for(let i of r.learningItems)if(!this.isItemCompleted(i.id))return{lessonId:r.id,itemId:i.id};let o=this.courseService.getFirstLearningItem(e);return o?{lessonId:o.lesson.id,itemId:o.item.id}:null}getVideoProgress(e){let t=this.progressStore().items[e];return t?.videoProgress?{currentTime:t.videoProgress.currentTime,duration:t.videoProgress.duration}:null}resetCourseProgress(e){let t=this.progressStore(),s=this.courseService.getCourseById(e);if(!s)return;let o=g({},t.items);s.lessons.forEach(m=>{m.learningItems.forEach(n=>{delete o[n.id]})});let r=g({},t.courses);delete r[e];let i={courses:r,items:o,lastActivity:new Date().toISOString()};this.progressStore.set(i),this.saveProgressStore(i)}getRecentlyViewedCourses(e=5){let t=this.progressStore().courses;return Object.values(t).sort((s,o)=>new Date(o.lastViewedAt).getTime()-new Date(s.lastViewedAt).getTime()).slice(0,e).map(s=>s.courseId)}loadProgressStore(){try{let e=localStorage.getItem(this.PROGRESS_KEY);if(e)return JSON.parse(e)}catch(e){console.warn("Failed to load progress store:",e)}return{courses:{},items:{},lastActivity:new Date().toISOString()}}saveProgressStore(e){try{localStorage.setItem(this.PROGRESS_KEY,JSON.stringify(e))}catch(t){console.warn("Failed to save progress store:",t)}}static \u0275fac=function(t){return new(t||d)};static \u0275prov=S({token:d,factory:d.\u0275fac,providedIn:"root"})};export{f as a};
