@if (loading()) {
  <div class="loading-container">
    <div class="loading-spinner"></div>
    <p>Loading content...</p>
  </div>
} @else if (error()) {
  <div class="error-container">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="12" cy="12" r="10"/>
      <line x1="12" y1="8" x2="12" y2="12"/>
      <line x1="12" y1="16" x2="12.01" y2="16"/>
    </svg>
    <h2>{{ error() }}</h2>
    <button class="btn btn-primary" (click)="backToCourse()">Back to Course</button>
  </div>
} @else {
  <div class="lesson-viewer" [class.sidebar-collapsed]="sidebarCollapsed()">
    <!-- Header -->
    <header class="viewer-header">
      <div class="header-left">
        <button class="back-btn" (click)="backToCourse()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="15 18 9 12 15 6"/>
          </svg>
          <span>{{ course()?.title }}</span>
        </button>
      </div>
      
      <div class="header-center">
        <div class="progress-info">
          <span class="progress-text">Course Progress: {{ courseProgress() }}%</span>
          <div class="progress-bar">
            <div class="progress-fill" [style.width.%]="courseProgress()"></div>
          </div>
        </div>
      </div>
      
      <div class="header-right">
        <button class="sidebar-toggle" (click)="toggleSidebar()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            @if (sidebarCollapsed()) {
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
              <line x1="9" y1="3" x2="9" y2="21"/>
            } @else {
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
              <line x1="15" y1="3" x2="15" y2="21"/>
            }
          </svg>
        </button>
      </div>
    </header>
    
    <!-- Main Content Area -->
    <div class="viewer-body">
      <!-- Content Area -->
      <main class="content-area">
        @if (currentItem(); as item) {
          <!-- Content Header -->
          <div class="content-header">
            <div class="item-type-badge" [attr.data-type]="item.type">
              @switch (item.type) {
                @case ('video') { Video }
                @case ('pdf') { Document }
                @case ('url') { Article }
              }
            </div>
            <h1>{{ item.title }}</h1>
            @if (item.description) {
              <p class="item-description">{{ item.description }}</p>
            }
          </div>
          
          <!-- Content Viewer -->
          <div class="content-viewer">
            @switch (item.type) {
              <!-- Video Content -->
              @case ('video') {
                <div class="video-container">
                  @if (isYouTubeVideo(item) || isVimeoVideo(item)) {
                    <iframe
                      [src]="getVideoEmbedUrl(item)"
                      frameborder="0"
                      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                      allowfullscreen
                    ></iframe>
                  } @else {
                    <video
                      controls
                      [src]="item.videoUrl"
                      preload="metadata"
                    >
                      Your browser does not support the video tag.
                    </video>
                  }
                </div>
                
                @if (item.videoDuration) {
                  <div class="video-meta">
                    <span class="duration">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12 6 12 12 16 14"/>
                      </svg>
                      Duration: {{ item.videoDuration }}
                    </span>
                  </div>
                }
              }
              
              <!-- PDF Content -->
              @case ('pdf') {
                <div class="pdf-container">
                  <iframe
                    [src]="getPdfViewerUrl(item.pdfUrl || '')"
                    frameborder="0"
                  ></iframe>
                  
                  <div class="pdf-fallback">
                    <p>If the PDF doesn't load, you can:</p>
                    <button class="btn btn-secondary" (click)="openInNewTab(item.pdfUrl || '')">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                        <polyline points="15 3 21 3 21 9"/>
                        <line x1="10" y1="14" x2="21" y2="3"/>
                      </svg>
                      Open PDF in New Tab
                    </button>
                  </div>
                </div>
              }
              
              <!-- URL/External Content -->
              @case ('url') {
                <div class="url-container">
                  <!-- Try to embed, but provide fallback -->
                  <div class="embed-wrapper">
                    <iframe
                      [src]="getExternalUrl(item.url || '')"
                      frameborder="0"
                      sandbox="allow-same-origin allow-scripts allow-popups allow-forms"
                    ></iframe>
                  </div>
                  
                  <div class="url-actions">
                    <p class="url-hint">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="16" x2="12" y2="12"/>
                        <line x1="12" y1="8" x2="12.01" y2="8"/>
                      </svg>
                      Some websites may not load in the embedded viewer due to security restrictions.
                    </p>
                    <button class="btn btn-primary" (click)="openInNewTab(item.url || '')">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                        <polyline points="15 3 21 3 21 9"/>
                        <line x1="10" y1="14" x2="21" y2="3"/>
                      </svg>
                      Open in New Tab
                    </button>
                  </div>
                </div>
              }
            }
          </div>
          
          <!-- Content Actions -->
          <div class="content-actions">
            <div class="nav-buttons">
              <button 
                class="btn btn-secondary"
                [disabled]="!hasPrevious()"
                (click)="goToPrevious()"
              >
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="15 18 9 12 15 6"/>
                </svg>
                Previous
              </button>
              
              <button 
                class="btn btn-secondary"
                [disabled]="!hasNext()"
                (click)="goToNext()"
              >
                Next
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="9 18 15 12 9 6"/>
                </svg>
              </button>
            </div>
            
            <button 
              class="btn btn-complete"
              [class.completed]="isCurrentItemCompleted()"
              (click)="markAsComplete()"
              [disabled]="isCurrentItemCompleted()"
            >
              @if (isCurrentItemCompleted()) {
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"/>
                </svg>
                Completed
              } @else {
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/>
                  <polyline points="12 6 12 12 16 14"/>
                </svg>
                Mark as Complete
              }
            </button>
          </div>
        }
      </main>
      
      <!-- Sidebar - Lesson Items -->
      <aside class="lesson-sidebar">
        <div class="sidebar-header">
          <h3>{{ lesson()?.title }}</h3>
          <div class="lesson-progress">
            <span>{{ lessonProgress() }}% complete</span>
            <div class="progress-bar">
              <div class="progress-fill" [style.width.%]="lessonProgress()"></div>
            </div>
          </div>
        </div>
        
        <div class="sidebar-content">
          <ul class="items-list">
            @for (item of lesson()?.learningItems; track item.id; let i = $index) {
              <li 
                class="item"
                [class.active]="item.id === currentItemId()"
                [class.completed]="isItemCompleted(item.id)"
                (click)="selectItem(item)"
              >
                <div class="item-number">
                  @if (isItemCompleted(item.id)) {
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="20 6 9 17 4 12"/>
                    </svg>
                  } @else {
                    {{ i + 1 }}
                  }
                </div>
                
                <div class="item-info">
                  <span class="item-title">{{ item.title }}</span>
                  <span class="item-meta">
                    @switch (item.type) {
                      @case ('video') {
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <polygon points="5 3 19 12 5 21 5 3"/>
                        </svg>
                        @if (item.videoDuration) {
                          {{ item.videoDuration }}
                        } @else {
                          Video
                        }
                      }
                      @case ('pdf') {
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                          <polyline points="14 2 14 8 20 8"/>
                        </svg>
                        Document
                      }
                      @case ('url') {
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                          <polyline points="15 3 21 3 21 9"/>
                          <line x1="10" y1="14" x2="21" y2="3"/>
                        </svg>
                        Article
                      }
                    }
                  </span>
                </div>
              </li>
            }
          </ul>
        </div>
        
        <!-- Other Lessons -->
        @if (course()?.lessons && course()!.lessons.length > 1) {
          <div class="other-lessons">
            <h4>Other Lessons</h4>
            <ul class="lessons-nav">
              @for (les of course()?.lessons; track les.id) {
                @if (les.id !== lessonId()) {
                  <li 
                    class="lesson-nav-item"
                    (click)="navigateToLesson(les.id, les.learningItems[0].id)"
                  >
                    <span class="lesson-title">{{ les.title }}</span>
                    <span class="lesson-count">{{ les.learningItems.length }} items</span>
                  </li>
                }
              }
            </ul>
          </div>
        }
      </aside>
    </div>
  </div>
  
  <!-- Completion Modal -->
  @if (showCompletionModal()) {
    <div class="modal-overlay" (click)="closeCompletionModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
            <polyline points="22 4 12 14.01 9 11.01"/>
          </svg>
        </div>
        <h2>Congratulations!</h2>
        <p>You've completed this lesson. Great job on your learning journey!</p>
        
        <div class="completion-stats">
          <div class="stat">
            <span class="stat-value">{{ courseProgress() }}%</span>
            <span class="stat-label">Course Progress</span>
          </div>
        </div>
        
        <div class="modal-actions">
          @if (hasNext()) {
            <button class="btn btn-primary" (click)="goToNext(); closeCompletionModal()">
              Continue to Next
            </button>
          }
          <button class="btn btn-secondary" (click)="backToCourse()">
            Back to Course
          </button>
          <button class="btn btn-link" (click)="continueToCourses()">
            Browse More Courses
          </button>
        </div>
      </div>
    </div>
  }
}
